{{define "view"}}
<main class="w-full px-4 py-8">
  <!-- Hero Section -->
  <div class="text-center mb-8" style="max-width: 1400px; margin: 0 auto;">
    <h1 class="text-4xl md:text-6xl font-bold text-textPrimary mb-4 neon-glow">
      ‚Çø Bitcoin Dashboard
    </h1>
    <p class="text-xl md:text-2xl italic text-orange-500 mb-6 neon-glow-orange">
      Real-time Bitcoin metrics and tools
    </p>
  </div>

  <!-- Current Price Card (Large Featured) -->
  <div class="cyber-card warm-glow rounded-xl border-2 border-orange-500 p-8 mb-8" style="max-width: 1400px; margin: 0 auto 2rem auto;">
    <h2 class="text-2xl font-bold text-textPrimary mb-4 text-center neon-glow">Current Bitcoin Price</h2>
    <div class="text-center mb-6">
      <div
        id="btc-price"
        class="text-5xl md:text-7xl font-bold text-orange-500 neon-glow-orange mb-2"
        hx-get="/api/btc-price"
        hx-trigger="load, every 30s"
        hx-swap="innerHTML"
        hx-target="this"
        _="on htmx:afterRequest
              set the innerHTML of me to '$' + JSON.parse(event.detail.xhr.responseText).Price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"
      >
        Loading...
      </div>
      <div id="usd-to-sats" class="text-lg text-textMuted mt-2">
        Calculating sats per dollar...
      </div>
    </div>

    <!-- Price Chart -->
    <div class="mt-8">
      <div class="flex flex-wrap justify-center gap-2 mb-6">
        <button onclick="updateChart('1D')" class="cyber-button px-4 py-2 text-sm font-bold rounded-lg" id="btn-1D">1D</button>
        <button onclick="updateChart('1W')" class="cyber-button px-4 py-2 text-sm font-bold rounded-lg" id="btn-1W">1W</button>
        <button onclick="updateChart('1M')" class="cyber-button px-4 py-2 text-sm font-bold rounded-lg" id="btn-1M">1M</button>
        <button onclick="updateChart('3M')" class="cyber-button px-4 py-2 text-sm font-bold rounded-lg" id="btn-3M">3M</button>
        <button onclick="updateChart('1Y')" class="cyber-button px-4 py-2 text-sm font-bold rounded-lg" id="btn-1Y">1Y</button>
        <button onclick="updateChart('ALL')" class="cyber-button-primary px-4 py-2 text-sm font-bold rounded-lg text-white" id="btn-ALL">ALL</button>
      </div>
      <div class="cyber-card rounded-lg border-2 border-textHighlighted p-4 bg-bgSecondary" style="position: relative; height: 400px;">
        <canvas id="btcChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" style="max-width: 1400px; margin: 0 auto;">

    <!-- Block Height Card -->
    <div class="cyber-card warm-glow rounded-xl border-2 border-textHighlighted p-6 text-center">
      <div class="text-3xl mb-2">üì¶</div>
      <h3 class="text-lg font-bold text-textPrimary mb-2 neon-glow">Block Height</h3>
      <div id="block-height" class="text-2xl font-bold text-orange-500">
        Loading...
      </div>
    </div>

    <!-- Market Cap Card -->
    <div class="cyber-card warm-glow rounded-xl border-2 border-textHighlighted p-6 text-center">
      <div class="text-3xl mb-2">üí∞</div>
      <h3 class="text-lg font-bold text-textPrimary mb-2 neon-glow">Market Cap</h3>
      <div class="text-2xl font-bold text-orange-500">
        ~$2.1T
      </div>
      <div class="text-xs text-textMuted mt-1">Estimated</div>
    </div>

    <!-- 24h Volume Card -->
    <div class="cyber-card warm-glow rounded-xl border-2 border-textHighlighted p-6 text-center">
      <div class="text-3xl mb-2">üìä</div>
      <h3 class="text-lg font-bold text-textPrimary mb-2 neon-glow">Circulating Supply</h3>
      <div class="text-2xl font-bold text-orange-500">
        ~19.8M
      </div>
      <div class="text-xs text-textMuted mt-1">/ 21M total</div>
    </div>

    <!-- Halving Countdown Card -->
    <div class="cyber-card warm-glow rounded-xl border-2 border-textHighlighted p-6 text-center">
      <div class="text-3xl mb-2">‚è≥</div>
      <h3 class="text-lg font-bold text-textPrimary mb-2 neon-glow">Next Halving</h3>
      <div class="text-2xl font-bold text-orange-500">
        2028
      </div>
      <div class="text-xs text-textMuted mt-1">Estimated</div>
    </div>

  </div>

  <!-- Calculator Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8" style="max-width: 1400px; margin: 0 auto;">

    <!-- Interactive Calculator -->
    <div class="cyber-card warm-glow rounded-xl border-2 border-orange-500 p-8">
      <h2 class="text-2xl font-bold text-textPrimary text-center mb-6 neon-glow">
        Sats ‚ÜîÔ∏è Fiat Calculator
      </h2>

      <div class="space-y-6">
        <!-- Currency Selector -->
        <div class="text-center">
          <label class="text-textMuted text-sm mb-2 block">Select Currency</label>
          <select
            id="currency-select"
            onchange="updateCurrency()"
            class="cyber-button px-6 py-3 font-bold rounded-lg bg-bgSecondary text-textPrimary border-2 border-textHighlighted cursor-pointer focus:outline-none focus:ring-2 focus:ring-orange-500"
            style="color-scheme: dark;"
          >
            <option value="USD" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üá∫üá∏ USD - US Dollar</option>
            <option value="EUR" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üá™üá∫ EUR - Euro</option>
            <option value="GBP" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üá¨üáß GBP - British Pound</option>
            <option value="JPY" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üáØüáµ JPY - Japanese Yen</option>
            <option value="CAD" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üá®üá¶ CAD - Canadian Dollar</option>
            <option value="AUD" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üá¶üá∫ AUD - Australian Dollar</option>
            <option value="CHF" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üá®üá≠ CHF - Swiss Franc</option>
            <option value="CNY" style="background-color: var(--color-bgSecondary, #1a1a2e); color: var(--color-textPrimary, #e0e0e0);">üá®üá≥ CNY - Chinese Yuan</option>
          </select>
        </div>

        <!-- Sats Input -->
        <div>
          <label class="text-textMuted text-sm mb-2 block text-center">Satoshis</label>
          <div class="flex items-center space-x-3">
            <input
              type="number"
              id="sats-input"
              class="flex-1 p-4 text-xl text-textPrimary bg-bgSecondary border-2 border-textHighlighted rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-center"
              placeholder="0"
              oninput="calculateFromSats()"
            />
            <div class="text-xl font-bold text-orange-500 neon-glow-orange min-w-[80px] text-center">
              sats
            </div>
          </div>
        </div>

        <!-- Exchange Icon -->
        <div class="text-center">
          <div class="text-3xl text-orange-500">‚ÜïÔ∏è</div>
        </div>

        <!-- Fiat Input -->
        <div>
          <label class="text-textMuted text-sm mb-2 block text-center" id="fiat-label">US Dollar</label>
          <div class="flex items-center space-x-3">
            <input
              type="number"
              id="fiat-input"
              class="flex-1 p-4 text-xl text-textPrimary bg-bgSecondary border-2 border-textHighlighted rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-center"
              placeholder="0.00"
              step="0.01"
              oninput="calculateFromFiat()"
            />
            <div class="text-xl font-bold text-orange-500 neon-glow-orange min-w-[80px] text-center" id="currency-symbol">
              USD
            </div>
          </div>
        </div>

        <!-- Exchange Rate Display -->
        <div class="cyber-card rounded-lg border-2 border-textHighlighted p-4 bg-bgSecondary text-center">
          <p class="text-sm text-textMuted mb-1">Current Exchange Rate</p>
          <p class="text-lg font-bold text-orange-500" id="exchange-rate">
            Loading...
          </p>
        </div>
      </div>
    </div>

    <!-- BIP172 Card -->
    <div class="cyber-card warm-glow rounded-xl border-2 border-textHighlighted p-8">
      <h2 class="text-2xl font-bold text-textPrimary text-center mb-6 neon-glow">
        üìú BIP 172
      </h2>

      <div class="space-y-4 text-textMuted">
        <div class="cyber-card rounded-lg border-2 border-orange-500 p-4 bg-bgSecondary">
          <h3 class="text-lg font-bold text-orange-500 mb-2">Define Bitcoin Subunits as Satoshis</h3>
          <p class="text-sm">
            A Bitcoin Improvement Proposal to formally standardize Bitcoin's smallest unit as "satoshi" or "sats".
          </p>
        </div>

        <div class="space-y-2">
          <p class="text-sm">
            <span class="text-orange-500 font-bold">Author:</span> OceanSlim (that's me!)
          </p>
          <p class="text-sm">
            <span class="text-orange-500 font-bold">Status:</span> Draft
          </p>
          <p class="text-sm">
            <span class="text-orange-500 font-bold">Type:</span> Informational
          </p>
          <p class="text-sm">
            <span class="text-orange-500 font-bold">Created:</span> 2025-05-01
          </p>
        </div>

        <div class="cyber-card rounded-lg border-2 border-textHighlighted p-4 bg-bgSecondary">
          <p class="text-sm mb-3">
            As Bitcoin adoption grows, the need for clear, standardized terminology becomes increasingly important.
            This BIP aims to improve clarity across UIs, documentation, and development.
          </p>
          <p class="text-sm font-bold text-orange-500">
            1 Bitcoin = 100,000,000 satoshis
          </p>
        </div>

        <div class="text-center">
          <a
            href="https://github.com/bitcoin/bips/blob/master/bip-0172.mediawiki"
            target="_blank"
            class="cyber-button-primary inline-block px-6 py-3 font-bold text-white rounded-lg"
          >
            Read Full BIP
          </a>
        </div>
      </div>
    </div>

  </div>


  <!-- Useful Links Section -->
  <div class="cyber-card warm-glow rounded-xl border-2 border-orange-500 p-8" style="max-width: 1400px; margin: 0 auto;">
    <h2 class="text-2xl font-bold text-textPrimary text-center mb-6 neon-glow">
      Bitcoin Resources
    </h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <a
        href="https://mempool.space"
        target="_blank"
        class="cyber-button block px-4 py-3 text-center rounded-lg"
      >
        Mempool.space
      </a>
      <a
        href="https://bitcoinexplorer.org"
        target="_blank"
        class="cyber-button block px-4 py-3 text-center rounded-lg"
      >
        Block Explorer
      </a>
      <a
        href="/bitcoin-works"
        hx-get="/bitcoin-works"
        hx-push-url="/bitcoin-works"
        hx-swap="outerHTML"
        hx-target="body"
        class="cyber-button block px-4 py-3 text-center rounded-lg"
      >
        How Bitcoin Works
      </a>
      <a
        href="https://books.happytavern.co"
        target="_blank"
        class="cyber-button block px-4 py-3 text-center rounded-lg"
      >
        Bitcoin Books
      </a>
    </div>
  </div>

</main>

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  let priceChart = null;
  let allPriceData = [];
  let currentTimeframe = 'ALL';
  let currentCurrency = 'USD';
  let exchangeRates = {};
  let btcPriceUSD = 0;

  // Currency names
  const currencyNames = {
    'USD': 'US Dollar',
    'EUR': 'Euro',
    'GBP': 'British Pound',
    'JPY': 'Japanese Yen',
    'CAD': 'Canadian Dollar',
    'AUD': 'Australian Dollar',
    'CHF': 'Swiss Franc',
    'CNY': 'Chinese Yuan'
  };

  // Update sats per dollar calculator
  document.addEventListener("htmx:afterRequest", function (event) {
    if (event.target.id === "btc-price") {
      const response = JSON.parse(event.detail.xhr.responseText);
      btcPriceUSD = parseFloat(response.Price);

      if (!isNaN(btcPriceUSD) && btcPriceUSD > 0) {
        const satsPerUsd = Math.round(100_000_000 / btcPriceUSD);
        document.getElementById("usd-to-sats").textContent =
          `1 USD = ${satsPerUsd.toLocaleString('en-US')} sats`;

        // Fetch exchange rates and update calculator
        fetchExchangeRates();
      }
    }
  });

  // Fetch block height
  async function fetchBlockHeight() {
    try {
      const response = await fetch('https://blockchain.info/q/getblockcount');
      const blockHeight = await response.text();
      document.getElementById('block-height').textContent = parseInt(blockHeight).toLocaleString('en-US');
    } catch (error) {
      console.error('Error fetching block height:', error);
      document.getElementById('block-height').textContent = '~880,000';
    }
  }

  // Fetch exchange rates
  async function fetchExchangeRates() {
    try {
      const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
      const data = await response.json();
      exchangeRates = data.rates;
      updateExchangeRateDisplay();
    } catch (error) {
      console.error('Error fetching exchange rates:', error);
      // Fallback rates
      exchangeRates = {
        'USD': 1,
        'EUR': 0.92,
        'GBP': 0.79,
        'JPY': 149.50,
        'CAD': 1.36,
        'AUD': 1.52,
        'CHF': 0.88,
        'CNY': 7.24
      };
      updateExchangeRateDisplay();
    }
  }

  // Update currency selector
  function updateCurrency() {
    currentCurrency = document.getElementById('currency-select').value;
    document.getElementById('fiat-label').textContent = currencyNames[currentCurrency];
    document.getElementById('currency-symbol').textContent = currentCurrency;
    updateExchangeRateDisplay();

    // Recalculate if there's a value in sats input
    const satsInput = document.getElementById('sats-input');
    if (satsInput.value) {
      calculateFromSats();
    }
  }

  // Update exchange rate display
  function updateExchangeRateDisplay() {
    if (!btcPriceUSD || !exchangeRates[currentCurrency]) {
      document.getElementById('exchange-rate').textContent = 'Loading...';
      return;
    }

    const btcPriceInCurrency = btcPriceUSD * exchangeRates[currentCurrency];
    const satsPerUnit = Math.round(100_000_000 / btcPriceInCurrency);

    document.getElementById('exchange-rate').textContent =
      `1 ${currentCurrency} = ${satsPerUnit.toLocaleString('en-US')} sats`;
  }

  // Calculate from sats input
  function calculateFromSats() {
    const satsInput = document.getElementById('sats-input');
    const fiatInput = document.getElementById('fiat-input');

    const sats = parseFloat(satsInput.value);

    if (isNaN(sats) || sats < 0 || !btcPriceUSD || !exchangeRates[currentCurrency]) {
      fiatInput.value = '';
      return;
    }

    const btcPriceInCurrency = btcPriceUSD * exchangeRates[currentCurrency];
    const fiatValue = (sats / 100_000_000) * btcPriceInCurrency;

    fiatInput.value = fiatValue.toFixed(2);
  }

  // Calculate from fiat input
  function calculateFromFiat() {
    const satsInput = document.getElementById('sats-input');
    const fiatInput = document.getElementById('fiat-input');

    const fiat = parseFloat(fiatInput.value);

    if (isNaN(fiat) || fiat < 0 || !btcPriceUSD || !exchangeRates[currentCurrency]) {
      satsInput.value = '';
      return;
    }

    const btcPriceInCurrency = btcPriceUSD * exchangeRates[currentCurrency];
    const sats = (fiat / btcPriceInCurrency) * 100_000_000;

    satsInput.value = Math.round(sats);
  }

  // Fetch price data and initialize chart
  async function fetchPriceData() {
    try {
      const response = await fetch('/api/btc-price-log');
      allPriceData = await response.json();
      updateChart('ALL');
    } catch (error) {
      console.error('Error fetching price data:', error);
    }
  }

  // Filter data based on timeframe
  function filterDataByTimeframe(timeframe) {
    const now = Date.now() / 1000; // Current time in seconds
    let cutoffTime;

    switch(timeframe) {
      case '1D':
        cutoffTime = now - (24 * 60 * 60);
        break;
      case '1W':
        cutoffTime = now - (7 * 24 * 60 * 60);
        break;
      case '1M':
        cutoffTime = now - (30 * 24 * 60 * 60);
        break;
      case '3M':
        cutoffTime = now - (90 * 24 * 60 * 60);
        break;
      case '1Y':
        cutoffTime = now - (365 * 24 * 60 * 60);
        break;
      case 'ALL':
      default:
        return allPriceData;
    }

    return allPriceData.filter(entry => entry.unixTimestamp >= cutoffTime);
  }

  // Update chart with filtered data
  function updateChart(timeframe) {
    currentTimeframe = timeframe;

    // Update button styles
    ['1D', '1W', '1M', '3M', '1Y', 'ALL'].forEach(tf => {
      const btn = document.getElementById(`btn-${tf}`);
      if (tf === timeframe) {
        btn.classList.remove('cyber-button');
        btn.classList.add('cyber-button-primary', 'text-white');
      } else {
        btn.classList.remove('cyber-button-primary', 'text-white');
        btn.classList.add('cyber-button');
      }
    });

    const filteredData = filterDataByTimeframe(timeframe);

    // Sample data for better performance (show every Nth point based on data size)
    let samplingRate = 1;
    if (filteredData.length > 1000) {
      samplingRate = Math.ceil(filteredData.length / 1000);
    }

    const sampledData = filteredData.filter((_, index) => index % samplingRate === 0);

    const labels = sampledData.map(entry => {
      const date = new Date(entry.unixTimestamp * 1000);
      if (timeframe === '1D') {
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    });

    const prices = sampledData.map(entry => parseFloat(entry.price));

    if (priceChart) {
      priceChart.destroy();
    }

    const ctx = document.getElementById('btcChart').getContext('2d');

    // Get colors from CSS variables or use defaults
    const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--color-textHighlighted') || 'rgba(128, 90, 213, 0.2)';
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-textMuted') || '#a0aec0';
    const lineColor = '#f97316'; // Orange

    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Bitcoin Price (USD)',
          data: prices,
          borderColor: lineColor,
          backgroundColor: 'rgba(249, 115, 22, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 4,
          pointHoverBackgroundColor: lineColor,
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: lineColor,
            bodyColor: '#fff',
            borderColor: lineColor,
            borderWidth: 1,
            padding: 12,
            displayColors: false,
            callbacks: {
              label: function(context) {
                return '$' + context.parsed.y.toLocaleString('en-US', {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2
                });
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: gridColor,
              drawBorder: false
            },
            ticks: {
              color: textColor,
              maxRotation: 0,
              autoSkipPadding: 20
            }
          },
          y: {
            grid: {
              color: gridColor,
              drawBorder: false
            },
            ticks: {
              color: textColor,
              callback: function(value) {
                return '$' + value.toLocaleString('en-US', {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 0
                });
              }
            }
          }
        }
      }
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    fetchPriceData();
    fetchBlockHeight();
    // Update block height every 60 seconds
    setInterval(fetchBlockHeight, 60000);
  });
</script>
{{end}}
